{% extends "base.html" %}

{% block title %}Dashboard - Writify{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-900 text-white">
    <!-- Navigation Bar -->
    <nav class="border-b border-gray-800 bg-gray-900/95 backdrop-blur-sm sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <!-- Logo -->
                <div class="flex items-center">
                    <span class="text-xl font-semibold">Writify.</span>
                </div>

                <!-- User Menu -->
                <div class="flex items-center space-x-4">
                    <div class="flex items-center space-x-3">
                        {% if user.avatar_url %}
                            <img src="{{ user.avatar_url }}" alt="{{ user.full_name }}" class="w-8 h-8 rounded-full">
                        {% else %}
                            <div class="w-8 h-8 bg-gray-700 rounded-full flex items-center justify-center">
                                <span class="text-sm font-medium">{{ user.first_name[0] }}{{ user.last_name[0] }}</span>
                            </div>
                        {% endif %}
                        <span class="text-sm font-medium">{{ user.first_name }}</span>
                    </div>
                    <button onclick="document.getElementById('create-dropdown').classList.toggle('hidden')" class="inline-flex items-center px-3 py-2 border border-gray-600 rounded-md text-sm font-medium text-white hover:bg-gray-800 transition-colors">
                        Create new
                        <svg class="ml-2 w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                        </svg>
                    </button>
                    <!-- Dropdown -->
                    <div id="create-dropdown" class="hidden absolute right-8 top-16 mt-2 w-48 bg-gray-800 border border-gray-700 rounded-md shadow-lg z-50">
                        <div class="py-1">
                            <a href="#" class="block px-4 py-2 text-sm text-gray-300 hover:bg-gray-700">New Document</a>
                            <a href="#" class="block px-4 py-2 text-sm text-gray-300 hover:bg-gray-700">New Project</a>
                            <div class="border-t border-gray-700 my-1"></div>
                            <a href="{{ url_for('auth.logout') }}" class="block px-4 py-2 text-sm text-gray-300 hover:bg-gray-700">Sign out</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="flex">
        <!-- Sidebar -->
        <aside class="w-64 bg-gray-800 border-r border-gray-700 min-h-screen">
            <div class="p-6">
                <!-- Search -->
                <div class="mb-6">
                    <div class="relative">
                        <input type="text" placeholder="Search..." class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md text-sm text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-white focus:border-transparent">
                        <svg class="absolute right-3 top-2.5 w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                    </div>
                </div>

                <!-- Navigation Menu -->
                <nav class="space-y-2">
                    <a href="#" class="flex items-center px-3 py-2 text-sm font-medium text-white bg-gray-700 rounded-md">
                        <svg class="mr-3 w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
                        </svg>
                        History
                    </a>
                    <a href="#" class="flex items-center px-3 py-2 text-sm font-medium text-gray-300 hover:text-white hover:bg-gray-700 rounded-md transition-colors">
                        <svg class="mr-3 w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
                        </svg>
                        Collections
                    </a>
                </nav>

                <!-- Uploaded Documents -->
                <div class="mt-8">
                    <h3 class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-3">Documents</h3>
                    <div id="documents-list" class="space-y-2">
                        {% for document in documents %}
                        <div class="flex items-center justify-between px-3 py-2 text-sm text-gray-300 hover:bg-gray-700 rounded-md cursor-pointer transition-colors" data-document-id="{{ document.id }}">
                            <div class="flex items-center flex-1 min-w-0">
                                <svg class="mr-3 w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                                <div class="flex-1 min-w-0">
                                    <div class="text-sm font-medium text-white truncate">{{ document.original_filename }}</div>
                                    <div class="text-xs text-gray-400">{{ document.file_type.upper() }} â€¢ {{ (document.file_size / 1024) | round(1) }}KB</div>
                                </div>
                            </div>
                            <button onclick="deleteDocument({{ document.id }})" class="ml-2 text-gray-400 hover:text-red-400 transition-colors">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                </svg>
                            </button>
                        </div>
                        {% endfor %}
                    </div>
                    
                    <!-- Upload Button -->
                    <div class="mt-3">
                        <input type="file" id="file-upload" accept=".pdf,.docx" class="hidden" onchange="uploadDocument()">
                        <button onclick="document.getElementById('file-upload').click()" class="w-full flex items-center justify-center px-3 py-2 border border-gray-600 text-gray-300 text-sm rounded-md hover:bg-gray-700 transition-colors">
                            <svg class="mr-2 w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                            </svg>
                            Upload PDF/DOCX
                        </button>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Content Area -->
        <main class="flex-1 flex flex-col">
            <!-- Title Input -->
            <div class="p-6 border-b border-gray-700">
                <input type="text" id="title-input" placeholder="Enter your writing title..." class="w-full text-2xl font-bold text-white bg-transparent border-none outline-none placeholder-gray-500" value="" />
            </div>

            <!-- Writing Area -->
            <div class="flex-1 p-6">
                <div class="max-w-4xl mx-auto">
                    <div class="bg-gray-800 rounded-lg border border-gray-700 min-h-96">
                        <div class="relative">
                            <!-- Modern AI Editor - Single Layer -->
                            <div id="editor-container" class="relative">
                                <div id="editor" 
                                     contenteditable="true" 
                                     class="w-full h-96 bg-transparent border-none outline-none text-gray-300 resize-none overflow-y-auto"
                                     style="font-family: ui-serif, Georgia, Cambria, serif; line-height: 1.7; padding: 24px; margin: 0; box-sizing: border-box;"
                                     data-placeholder="Start writing... AI suggestions will appear inline as you type.">
                                </div>
                                
                                <!-- Floating Suggestion Controls -->
                                <div id="suggestion-controls" class="hidden fixed z-50 bg-gray-800 rounded-lg shadow-lg border border-gray-600">
                                    <div class="flex items-center space-x-3 px-4 py-2 text-sm">
                                        <button id="accept-btn" class="flex items-center space-x-1 px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors">
                                            <span>Accept</span>
                                            <kbd class="ml-1 px-1 py-0.5 bg-blue-700 text-xs rounded">Tab</kbd>
                                        </button>
                                        <button id="try-again-btn" class="flex items-center space-x-1 px-3 py-1 border border-gray-600 text-gray-300 rounded hover:bg-gray-700 transition-colors">
                                            <span>Try Again</span>
                                            <kbd class="ml-1 px-1 py-0.5 bg-gray-600 text-xs rounded">Shift+Tab</kbd>
                                        </button>
                                        <button id="dismiss-btn" class="flex items-center space-x-1 px-3 py-1 border border-gray-600 text-gray-300 rounded hover:bg-gray-700 transition-colors">
                                            <span>Dismiss</span>
                                            <kbd class="ml-1 px-1 py-0.5 bg-gray-600 text-xs rounded">Esc</kbd>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- CSS for placeholder and suggestions -->
                            <style>
                                #editor:empty:before {
                                    content: attr(data-placeholder);
                                    color: #6b7280;
                                    pointer-events: none;
                                }
                                #editor:focus {
                                    outline: none;
                                }
                                .ai-suggestion {
                                    color: #6b7280;
                                    background: rgba(59, 130, 246, 0.1);
                                    border-radius: 2px;
                                    padding: 0 2px;
                                }
                            </style>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Right Panel -->
        <aside class="w-80 bg-gray-800 border-l border-gray-700 p-6">
            <div class="space-y-6">
                <!-- Writing Stats -->
                <div>
                    <h3 class="text-sm font-semibold text-white mb-3">Writing Stats</h3>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between text-gray-300">
                            <span>Words</span>
                            <span id="word-count">0</span>
                        </div>
                        <div class="flex justify-between text-gray-300">
                            <span>Characters</span>
                            <span id="char-count">0</span>
                        </div>
                        <div class="flex justify-between text-gray-300">
                            <span>Reading time</span>
                            <span id="reading-time">0 min</span>
                        </div>
                    </div>
                </div>

                <!-- AI Status -->
                <div>
                    <h3 class="text-sm font-semibold text-white mb-3">AI Assistant</h3>
                    <div id="ai-status" class="bg-gray-700 rounded-lg p-4">
                        <div class="flex items-center text-sm text-gray-400">
                            <div class="w-2 h-2 bg-green-400 rounded-full mr-2"></div>
                            Ready - Start writing with a title
                        </div>
                    </div>
                </div>

                <!-- Status Indicator -->
                <div id="status-indicator" class="hidden">
                    <div class="flex items-center text-sm text-gray-400">
                        <svg class="animate-spin mr-2 w-4 h-4" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        Getting AI suggestions...
                    </div>
                </div>
                
                <!-- Help Text -->
                <div class="text-xs text-gray-500 bg-gray-700 rounded-lg p-3">
                    <div class="space-y-1">
                        <div><kbd class="bg-gray-600 px-1 rounded">Tab</kbd> Accept suggestion</div>
                        <div><kbd class="bg-gray-600 px-1 rounded">Shift+Tab</kbd> Try again</div>
                        <div><kbd class="bg-gray-600 px-1 rounded">Esc</kbd> Dismiss</div>
                    </div>
                </div>
            </div>
        </aside>
    </div>
</div>

<script src="{{ url_for('static', filename='js/editor.js') }}"></script>
<script>
    // Close dropdown when clicking outside
    document.addEventListener('click', function(event) {
        const dropdown = document.getElementById('create-dropdown');
        const button = event.target.closest('button[onclick*="create-dropdown"]');
        
        if (!button && !dropdown.contains(event.target)) {
            dropdown.classList.add('hidden');
        }
    });

    // Document upload function
    async function uploadDocument() {
        const fileInput = document.getElementById('file-upload');
        const file = fileInput.files[0];
        
        if (!file) return;
        
        const formData = new FormData();
        formData.append('file', file);
        
        try {
            const response = await fetch('/api/upload', {
                method: 'POST',
                body: formData
            });
            
            const result = await response.json();
            
            if (result.success) {
                location.reload(); // Reload to show new document
            } else {
                alert(result.error || 'Upload failed');
            }
        } catch (error) {
            alert('Upload failed. Please try again.');
        }
        
        fileInput.value = ''; // Reset input
    }

    // Document delete function
    async function deleteDocument(documentId) {
        if (!confirm('Are you sure you want to delete this document?')) return;
        
        try {
            const response = await fetch(`/api/documents/${documentId}`, {
                method: 'DELETE'
            });
            
            const result = await response.json();
            
            if (result.success) {
                location.reload(); // Reload to remove document from list
            } else {
                alert('Failed to delete document');
            }
        } catch (error) {
            alert('Failed to delete document. Please try again.');
        }
    }
</script>
{% endblock %}