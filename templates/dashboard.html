{% extends "base.html" %}

{% block title %}Dashboard - Writify{% endblock %}

{% block content %}
<div class="min-h-screen">
    <!-- Navigation Bar -->
    <nav class="border-b border-gray-800 bg-black/95 backdrop-blur-sm sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <!-- Logo and Sidebar Toggle -->
                <div class="flex items-center space-x-4">
                    <button onclick="toggleSidebar()" class="p-2 text-gray-400 hover:text-white hover:bg-gray-900 rounded-md transition-colors">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                        </svg>
                    </button>
                    <span class="text-xl font-semibold">Writify.</span>
                </div>

                <!-- User Menu -->
                <div class="flex items-center space-x-4">
                    <!-- Subscription Status Badge -->
                    {% if is_trial_active %}
                        <div class="flex items-center space-x-2 px-3 py-1 bg-blue-950/80 border border-blue-800 rounded-full">
                            <div class="w-2 h-2 bg-blue-400 rounded-full"></div>
                            <span class="text-xs text-blue-300 font-medium">Trial: {{ days_left_in_trial }} days left</span>
                        </div>
                    {% elif subscription_status == 'trial' %}
                        <div class="flex items-center space-x-2 px-3 py-1 bg-red-950/80 border border-red-800 rounded-full">
                            <div class="w-2 h-2 bg-red-400 rounded-full"></div>
                            <span class="text-xs text-red-300 font-medium">Trial Expired</span>
                        </div>
                    {% elif is_subscription_active %}
                        <div class="flex items-center space-x-2 px-3 py-1 bg-green-950/80 border border-green-800 rounded-full">
                            <div class="w-2 h-2 bg-green-400 rounded-full"></div>
                            <span class="text-xs text-green-300 font-medium capitalize">{{ subscription_plan }} Plan</span>
                        </div>
                    {% elif subscription_status == 'past_due' %}
                        <div class="flex items-center space-x-2 px-3 py-1 bg-orange-950/80 border border-orange-800 rounded-full">
                            <div class="w-2 h-2 bg-orange-400 rounded-full"></div>
                            <span class="text-xs text-orange-300 font-medium">Payment Required</span>
                        </div>
                    {% endif %}

                    <!-- User Menu Button -->
                    <div class="relative">
                        <button onclick="document.getElementById('user-dropdown').classList.toggle('hidden')" class="flex items-center space-x-3 hover:bg-gray-900 px-3 py-2 rounded-md transition-colors">
                            {% if user.avatar_url %}
                                <img src="{{ user.avatar_url }}" alt="{{ user.full_name }}" class="w-8 h-8 rounded-full">
                            {% else %}
                                <div class="w-8 h-8 bg-gray-900 rounded-full flex items-center justify-center">
                                    <span class="text-sm font-medium">{{ user.first_name[0] }}{{ user.last_name[0] }}</span>
                                </div>
                            {% endif %}
                            <span class="text-sm font-medium">{{ user.first_name }}</span>
                            <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </button>
                        
                        <!-- User Dropdown -->
                        <div id="user-dropdown" class="hidden absolute right-0 top-12 mt-2 w-48 bg-black border border-gray-800 rounded-md shadow-lg z-50">
                            <div class="py-1">
                                <a href="{{ url_for('billing.index') }}" class="block px-4 py-2 text-sm text-gray-300 hover:bg-gray-900">Billing & Subscription</a>
                                {% if not has_valid_access %}
                                    <a href="{{ url_for('billing.pricing') }}" class="block px-4 py-2 text-sm text-blue-300 hover:bg-gray-900">Upgrade Plan</a>
                                {% endif %}
                                <div class="border-t border-gray-800 my-1"></div>
                                <a href="{{ url_for('auth.logout') }}" class="block px-4 py-2 text-sm text-gray-300 hover:bg-gray-900">Sign out</a>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Create New Button -->
                    <button onclick="startNewText()" class="inline-flex items-center px-3 py-2 border border-gray-800 rounded-md text-sm font-medium text-white hover:bg-gray-900 transition-colors">
                        Create new
                        <svg class="ml-2 w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="flex">
        <!-- Sidebar -->
        <aside id="sidebar" class="w-64 bg-black border-r border-gray-800 min-h-screen transition-all duration-300 ease-in-out">
            <div class="p-4">
                <!-- Search -->
                <div class="mb-6">
                    <div class="relative">
                        <input type="text" placeholder="Search..." class="w-full px-3 py-2 bg-gray-900/50 border-0 rounded-lg text-sm text-white placeholder-gray-500 focus:outline-none focus:ring-1 focus:ring-gray-700">
                        <svg class="absolute right-3 top-2.5 w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                    </div>
                </div>

                <!-- Navigation Menu -->
                <nav class="space-y-1">
                    <a href="#" class="flex items-center px-3 py-2 text-sm font-medium text-gray-300 hover:text-white hover:bg-gray-900 rounded-lg transition-colors">
                        <svg class="mr-3 w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        History
                    </a>
                </nav>

                <!-- Text Documents (only for active text) -->
                <div class="mt-6" id="text-documents-section" style="display: none;">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="text-xs font-medium text-gray-400 uppercase tracking-wide">Text Documents</h3>
                        <button onclick="showAddDocumentModal()" class="text-xs text-blue-400 hover:text-blue-300 transition-colors font-medium">
                            + Add
                        </button>
                    </div>
                    <div id="text-documents-list" class="space-y-1">
                        <!-- Documents associated with current text will be loaded here -->
                    </div>
                </div>

                <!-- All User Documents -->
                <div class="mt-6">
                    <h3 class="text-xs font-medium text-gray-400 uppercase tracking-wide mb-3">All Documents</h3>
                    <div id="documents-list" class="space-y-1">
                        {% for document in documents %}
                        <div class="flex items-center justify-between px-3 py-2 text-sm text-gray-300 hover:bg-gray-900 rounded-lg cursor-pointer transition-colors group" data-document-id="{{ document.id }}">
                            <div class="flex items-center flex-1 min-w-0">
                                <svg class="mr-3 w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                                <div class="flex-1 min-w-0">
                                    <div class="text-sm font-medium text-white truncate">{{ document.original_filename }}</div>
                                    <div class="text-xs text-gray-500">{{ document.file_type.upper() }} â€¢ {{ (document.file_size / 1024) | round(1) }}KB</div>
                                </div>
                            </div>
                            <button onclick="deleteDocument({{ document.id }})" class="ml-2 text-gray-500 hover:text-red-400 transition-colors opacity-0 group-hover:opacity-100">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                </svg>
                            </button>
                        </div>
                        {% endfor %}
                    </div>
                    
                    <!-- Upload Button -->
                    <div class="mt-3">
                        <input type="file" id="file-upload" accept=".pdf,.docx" class="hidden" onchange="uploadDocument()">
                        <button onclick="document.getElementById('file-upload').click()" class="w-full flex items-center justify-center px-3 py-2 border border-gray-800 text-gray-400 text-sm rounded-lg hover:bg-gray-900 hover:text-white transition-colors">
                            <svg class="mr-2 w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                            </svg>
                            Upload PDF/DOCX
                        </button>
                    </div>
                </div>

                <!-- Saved Texts -->
                <div class="mt-6">
                    <h3 class="text-xs font-medium text-gray-400 uppercase tracking-wide mb-3">My Texts</h3>
                    <div id="texts-list" class="space-y-1">
                        {% for text in texts %}
                        <div class="flex items-center justify-between px-3 py-2 text-sm text-gray-300 hover:bg-gray-900 rounded-lg cursor-pointer transition-colors group" data-text-id="{{ text.id }}">
                            <div class="flex items-center flex-1 min-w-0" onclick="loadTextIntoEditor({{ text.id }})">
                                <svg class="mr-3 w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                                <div class="flex-1 min-w-0">
                                    <div class="text-sm font-medium text-white truncate">{{ text.title }}</div>
                                    <div class="text-xs text-gray-500">{{ text.updated_at.strftime('%m/%d/%Y') }}</div>
                                </div>
                            </div>
                            <div class="flex items-center space-x-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                <button onclick="editText({{ text.id }})" class="text-gray-500 hover:text-blue-400 transition-colors">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                    </svg>
                                </button>
                                <button onclick="deleteText({{ text.id }})" class="text-gray-500 hover:text-red-400 transition-colors">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    
                </div>
            </div>
        </aside>

        <!-- Main Content Area -->
        <main class="flex-1 flex flex-col">
            <!-- Title Input -->
            <div>
                <div class="max-w-4xl mx-auto">
                    <input type="text" id="title-input" placeholder="Untitled" spellcheck="false" class="w-full text-3xl font-semibold text-white bg-transparent border-none outline-none placeholder-gray-600" 
                           style="padding: 32px 24px 24px 24px; margin: 0; box-sizing: border-box; line-height: 1.2;" value="" />
                </div>
            </div>

            <!-- Writing Area -->
            <div class="flex-1 p-6">
                <div class="max-w-4xl mx-auto">
                    <div class="bg-transparent min-h-96">
                        <div class="relative">
                            <!-- Modern AI Editor - Single Layer -->
                            <div id="editor-container" class="relative">
                                <div id="editor" 
                                     contenteditable="true" 
                                     spellcheck="false"
                                     class="w-full min-h-96 bg-transparent border-none outline-none text-gray-300 resize-none"
                                     style="font-family: ui-serif, Georgia, Cambria, serif; font-size: 16px; line-height: 1.8; padding: 24px; margin: 0; box-sizing: border-box; overflow: visible;"
                                     data-placeholder="Start writing... AI suggestions will appear inline as you type.">
                                </div>
                                
                                <!-- Floating Suggestion Controls -->
                                <div id="suggestion-controls" class="hidden fixed z-[60] bg-black rounded-lg shadow-xl border border-gray-800">
                                    <div class="flex items-center space-x-3 px-4 py-2 text-sm">
                                        <button id="accept-btn" class="flex items-center space-x-2 px-3 py-1.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                                            <span>Accept</span>
                                            <kbd class="px-1.5 py-0.5 bg-blue-700 text-xs rounded font-mono">Tab</kbd>
                                        </button>
                                        <button id="try-again-btn" class="flex items-center space-x-2 px-3 py-1.5 border border-gray-800 text-gray-300 rounded-lg hover:bg-gray-900 transition-colors">
                                            <span>Try Again</span>
                                            <kbd class="px-1.5 py-0.5 bg-gray-900 text-xs rounded font-mono">â‡§Tab</kbd>
                                        </button>
                                        <button id="dismiss-btn" class="flex items-center space-x-2 px-3 py-1.5 border border-gray-800 text-gray-300 rounded-lg hover:bg-gray-900 transition-colors">
                                            <span>Dismiss</span>
                                            <kbd class="px-1.5 py-0.5 bg-gray-900 text-xs rounded font-mono">Esc</kbd>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- CSS for placeholder and suggestions -->
                            <style>
                                #editor:empty:before {
                                    content: attr(data-placeholder);
                                    color: #6b7280;
                                    pointer-events: none;
                                    font-style: italic;
                                }
                                #editor:focus {
                                    outline: none;
                                }
                                .ai-suggestion {
                                    color: #6b7280;
                                    background: rgba(59, 130, 246, 0.08);
                                    border-radius: 4px;
                                    padding: 0 4px;
                                }
                                /* Auto-expanding editor */
                                #editor {
                                    overflow-wrap: break-word;
                                    word-wrap: break-word;
                                    white-space: pre-wrap;
                                }
                                
                                /* Fix sidebar spacing and prevent overlap */
                                aside {
                                    position: relative;
                                    z-index: 10;
                                }
                                
                                /* Sidebar toggle styles */
                                .sidebar-hidden {
                                    margin-left: -256px !important; /* Negative width of sidebar */
                                }
                                
                                .sidebar-hidden ~ main {
                                    margin-left: 0 !important;
                                }
                                
                                /* Bottom bar spacing */
                                main {
                                    padding-bottom: 70px; /* Space for bottom bar */
                                }
                                
                                /* Responsive bottom bar */
                                @media (max-width: 768px) {
                                    .bottom-bar-content {
                                        flex-direction: column;
                                        gap: 12px;
                                        align-items: center;
                                    }
                                    
                                    .bottom-bar-shortcuts {
                                        gap: 8px;
                                    }
                                    
                                    main {
                                        padding-bottom: 100px; /* More space on mobile */
                                    }
                                }
                                
                                /* Disable spellcheck globally */
                                * {
                                    -webkit-spellcheck: false !important;
                                    -moz-spellcheck: false !important;
                                    spellcheck: false !important;
                                }
                                
                                input, textarea, [contenteditable] {
                                    -webkit-spellcheck: false !important;
                                    -moz-spellcheck: false !important;
                                    spellcheck: false !important;
                                }
                            </style>
                        </div>
                    </div>
                </div>
            </div>
        </main>

    </div>

    <!-- Bottom Bar -->
    <div class="fixed bottom-0 left-0 right-0 bg-black border-t border-gray-800 z-40">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="bottom-bar-content flex items-center justify-between py-3">
                <!-- Writing Stats -->
                <div class="flex items-center space-x-6 text-sm">
                    <div class="flex items-center space-x-2">
                        <span class="text-gray-500 hidden sm:inline">Words</span>
                        <span class="text-gray-500 sm:hidden">W</span>
                        <span id="word-count" class="text-gray-300 font-medium">0</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <span class="text-gray-500 hidden sm:inline">Characters</span>
                        <span class="text-gray-500 sm:hidden">C</span>
                        <span id="char-count" class="text-gray-300 font-medium">0</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <span class="text-gray-500 hidden sm:inline">Reading time</span>
                        <span class="text-gray-500 sm:hidden">RT</span>
                        <span id="reading-time" class="text-gray-300 font-medium">0 min</span>
                    </div>
                </div>

                <!-- AI Assistant Shortcuts -->
                <div class="bottom-bar-shortcuts flex items-center space-x-4 text-xs text-gray-500">
                    <div class="flex items-center space-x-1.5">
                        <kbd class="bg-gray-900 px-2 py-1 rounded-lg border border-gray-800 text-xs font-mono">Tab</kbd>
                        <span class="hidden sm:inline">Accept</span>
                    </div>
                    <div class="flex items-center space-x-1.5">
                        <kbd class="bg-gray-900 px-2 py-1 rounded-lg border border-gray-800 text-xs font-mono">â‡§Tab</kbd>
                        <span class="hidden sm:inline">Try again</span>
                    </div>
                    <div class="flex items-center space-x-1.5">
                        <kbd class="bg-gray-900 px-2 py-1 rounded-lg border border-gray-800 text-xs font-mono">Esc</kbd>
                        <span class="hidden sm:inline">Dismiss</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for Create/Edit Text -->
    <div id="text-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-black rounded-lg max-w-2xl w-full max-h-[90vh] overflow-hidden">
            <div class="flex justify-between items-center p-6 border-b border-gray-800">
                <h3 id="modal-title" class="text-lg font-semibold text-white">New Text</h3>
                <button onclick="closeTextModal()" class="text-gray-400 hover:text-white">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <form id="text-form" class="flex flex-col h-full">
                <div class="p-6 flex-1 overflow-y-auto">
                    <div class="mb-4">
                        <label for="text-title" class="block text-sm font-medium text-gray-300 mb-2">Title</label>
                        <input type="text" id="text-title" name="title" required spellcheck="false"
                               class="w-full px-3 py-2 bg-gray-900 border border-gray-800 rounded-md text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                               placeholder="Enter text title...">
                    </div>
                    <div class="mb-4">
                        <label for="text-content" class="block text-sm font-medium text-gray-300 mb-2">Content</label>
                        <textarea id="text-content" name="content" rows="15" spellcheck="false"
                                  class="w-full px-3 py-2 bg-gray-900 border border-gray-800 rounded-md text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none"
                                  placeholder="Write your text here..."></textarea>
                    </div>
                </div>
                <div class="flex justify-end space-x-3 p-6 border-t border-gray-800">
                    <button type="button" onclick="closeTextModal()" 
                            class="px-4 py-2 text-gray-300 hover:text-white transition-colors">
                        Cancel
                    </button>
                    <button type="submit" 
                            class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors">
                        Save Text
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal for Add Documents to Text -->
    <div id="add-document-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-black rounded-lg max-w-2xl w-full max-h-[80vh] overflow-hidden">
            <div class="flex justify-between items-center p-6 border-b border-gray-800">
                <h3 class="text-lg font-semibold text-white">Add Documents to Text</h3>
                <button onclick="closeAddDocumentModal()" class="text-gray-400 hover:text-white">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div class="p-6 max-h-96 overflow-y-auto">
                <div id="available-documents-list" class="space-y-2">
                    <!-- Available documents will be loaded here -->
                </div>
                <div id="no-documents-message" class="text-center text-gray-400 py-8 hidden">
                    No available documents to add. Upload some documents first.
                </div>
            </div>
        </div>
    </div>
</div>

<script src="{{ url_for('static', filename='js/editor.js') }}"></script>
<script>
    // Close dropdown when clicking outside
    document.addEventListener('click', function(event) {
        const userDropdown = document.getElementById('user-dropdown');
        const userButton = event.target.closest('button[onclick*="user-dropdown"]');
        
        if (!userButton && !userDropdown.contains(event.target)) {
            userDropdown.classList.add('hidden');
        }
    });

    // Sidebar toggle function
    function toggleSidebar() {
        const sidebar = document.getElementById('sidebar');
        sidebar.classList.toggle('sidebar-hidden');
        
        // Save state to localStorage
        const isHidden = sidebar.classList.contains('sidebar-hidden');
        localStorage.setItem('sidebarHidden', isHidden);
    }

    // Restore sidebar state on page load
    document.addEventListener('DOMContentLoaded', function() {
        const sidebarHidden = localStorage.getItem('sidebarHidden') === 'true';
        if (sidebarHidden) {
            document.getElementById('sidebar').classList.add('sidebar-hidden');
        }
        
        // Disable spellcheck globally on all elements
        disableSpellcheckGlobally();
    });
    
    // Function to disable spellcheck on all elements
    function disableSpellcheckGlobally() {
        // Disable on all existing elements
        const allElements = document.querySelectorAll('input, textarea, [contenteditable]');
        allElements.forEach(element => {
            element.spellcheck = false;
            element.setAttribute('spellcheck', 'false');
        });
        
        // Override createElement to automatically disable spellcheck
        const originalCreateElement = document.createElement;
        document.createElement = function(tagName, options) {
            const element = originalCreateElement.call(this, tagName, options);
            if (tagName.toLowerCase() === 'input' || tagName.toLowerCase() === 'textarea') {
                element.spellcheck = false;
                element.setAttribute('spellcheck', 'false');
            }
            return element;
        };
        
        // Override setAttribute to prevent spellcheck from being set to true
        const originalSetAttribute = Element.prototype.setAttribute;
        Element.prototype.setAttribute = function(name, value) {
            if (name.toLowerCase() === 'contenteditable' && value !== 'false') {
                // When setting contenteditable, also set spellcheck to false
                originalSetAttribute.call(this, 'spellcheck', 'false');
                this.spellcheck = false;
            }
            if (name.toLowerCase() === 'spellcheck' && value !== 'false') {
                // Force spellcheck to always be false
                value = 'false';
            }
            return originalSetAttribute.call(this, name, value);
        };
        
        // Observe for dynamically added elements
        const observer = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                mutation.addedNodes.forEach(function(node) {
                    if (node.nodeType === 1) { // Element node
                        // Check if the added node is a text input element
                        if (node.matches && node.matches('input, textarea, [contenteditable]')) {
                            node.spellcheck = false;
                            node.setAttribute('spellcheck', 'false');
                            // Additional force for contenteditable
                            if (node.contentEditable && node.contentEditable !== 'false') {
                                node.spellcheck = false;
                                originalSetAttribute.call(node, 'spellcheck', 'false');
                            }
                        }
                        // Check for text input elements within the added node
                        const textInputs = node.querySelectorAll ? node.querySelectorAll('input, textarea, [contenteditable]') : [];
                        textInputs.forEach(input => {
                            input.spellcheck = false;
                            input.setAttribute('spellcheck', 'false');
                            // Additional force for contenteditable
                            if (input.contentEditable && input.contentEditable !== 'false') {
                                input.spellcheck = false;
                                originalSetAttribute.call(input, 'spellcheck', 'false');
                            }
                        });
                    }
                });
            });
        });
        
        // Start observing
        observer.observe(document.body, {
            childList: true,
            subtree: true
        });
        
        // Add event listeners to disable spellcheck on focus
        document.addEventListener('focusin', function(event) {
            const target = event.target;
            if (target.matches && target.matches('input, textarea, [contenteditable]')) {
                target.spellcheck = false;
                target.setAttribute('spellcheck', 'false');
            }
        });
        
        // Force disable on all existing elements every 500ms as a safety net
        setInterval(function() {
            const allElements = document.querySelectorAll('input, textarea, [contenteditable]');
            allElements.forEach(element => {
                if (element.spellcheck !== false) {
                    element.spellcheck = false;
                    element.setAttribute('spellcheck', 'false');
                }
            });
        }, 500);
    }

    // Document upload function
    async function uploadDocument() {
        const fileInput = document.getElementById('file-upload');
        const file = fileInput.files[0];
        
        if (!file) return;
        
        const formData = new FormData();
        formData.append('file', file);
        
        try {
            const response = await fetch('/api/upload', {
                method: 'POST',
                body: formData
            });
            
            const result = await response.json();
            
            if (result.success) {
                // Document uploaded successfully - could add to sidebar dynamically here if needed
                console.log('Document uploaded successfully');
            } else {
                alert(result.error || 'Upload failed');
            }
        } catch (error) {
            alert('Upload failed. Please try again.');
        }
        
        fileInput.value = ''; // Reset input
    }

    // Document delete function
    async function deleteDocument(documentId) {
        if (!confirm('Are you sure you want to delete this document?')) return;
        
        try {
            const response = await fetch(`/api/documents/${documentId}`, {
                method: 'DELETE'
            });
            
            const result = await response.json();
            
            if (result.success) {
                // Remove document from sidebar dynamically
                const documentElement = document.querySelector(`[data-document-id="${documentId}"]`);
                if (documentElement) {
                    documentElement.remove();
                }
            } else {
                alert('Failed to delete document');
            }
        } catch (error) {
            alert('Failed to delete document. Please try again.');
        }
    }

    // Text management variables
    let currentTextId = null;
    let isEditMode = false;

    // Create new text
    function createNewText() {
        currentTextId = null;
        isEditMode = false;
        document.getElementById('modal-title').textContent = 'New Text';
        document.getElementById('text-title').value = '';
        document.getElementById('text-content').value = '';
        document.getElementById('text-modal').classList.remove('hidden');
    }

    // Edit existing text
    async function editText(textId) {
        try {
            const response = await fetch(`/api/texts/${textId}`);
            const result = await response.json();
            
            if (result.success) {
                currentTextId = textId;
                isEditMode = true;
                document.getElementById('modal-title').textContent = 'Edit Text';
                document.getElementById('text-title').value = result.text.title;
                document.getElementById('text-content').value = result.text.content || '';
                document.getElementById('text-modal').classList.remove('hidden');
            } else {
                alert('Failed to load text');
            }
        } catch (error) {
            alert('Failed to load text. Please try again.');
        }
    }


    // Delete text
    async function deleteText(textId) {
        if (!confirm('Are you sure you want to delete this text?')) return;
        
        try {
            const response = await fetch(`/api/texts/${textId}`, {
                method: 'DELETE'
            });
            
            const result = await response.json();
            
            if (result.success) {
                // Remove text from sidebar
                const textElement = document.querySelector(`[data-text-id="${textId}"]`);
                if (textElement) {
                    textElement.remove();
                }
                
                // If this was the active text, clear the editor
                if (currentActiveTextId === textId) {
                    startNewText();
                }
            } else {
                alert('Failed to delete text');
            }
        } catch (error) {
            alert('Failed to delete text. Please try again.');
        }
    }

    // Close modal
    function closeTextModal() {
        document.getElementById('text-modal').classList.add('hidden');
        currentTextId = null;
        isEditMode = false;
    }

    // Handle form submission
    document.getElementById('text-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const title = document.getElementById('text-title').value.trim();
        const content = document.getElementById('text-content').value.trim();
        
        if (!title) {
            alert('Title is required');
            return;
        }
        
        try {
            const url = isEditMode ? `/api/texts/${currentTextId}` : '/api/texts';
            const method = isEditMode ? 'PUT' : 'POST';
            
            const response = await fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    title: title,
                    content: content
                })
            });
            
            const result = await response.json();
            
            if (result.success) {
                closeTextModal();
                // Update text in sidebar if it exists, otherwise add it
                const existingTextElement = document.querySelector(`[data-text-id="${result.text.id}"]`);
                if (existingTextElement) {
                    // Update existing text title in sidebar
                    const titleElement = existingTextElement.querySelector('.text-sm.font-medium.text-white.truncate');
                    if (titleElement) {
                        titleElement.textContent = result.text.title;
                    }
                } else {
                    addTextToSidebar(result.text);
                }
            } else {
                alert(result.error || 'Failed to save text');
            }
        } catch (error) {
            alert('Failed to save text. Please try again.');
        }
    });

    // Close modal when clicking outside
    document.getElementById('text-modal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeTextModal();
        }
    });

    // Close modal with Escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && !document.getElementById('text-modal').classList.contains('hidden')) {
            closeTextModal();
        }
    });

    // Auto-save functionality
    let currentActiveTextId = null;
    let autoSaveTimeout = null;
    let lastSavedTitle = '';
    let lastSavedContent = '';
    let isLoadingText = false;
    
    // Sync with global window variable for editor access
    window.currentActiveTextId = null; // Flag to prevent auto-save during text loading

    // Add text to sidebar dynamically
    function addTextToSidebar(text) {
        const textsList = document.getElementById('texts-list');
        const currentDate = new Date(text.updated_at).toLocaleDateString();
        
        const textElement = document.createElement('div');
        textElement.className = 'flex items-center justify-between px-3 py-2 text-sm text-gray-300 hover:bg-gray-900 rounded-lg cursor-pointer transition-colors group';
        textElement.setAttribute('data-text-id', text.id);
        
        textElement.innerHTML = `
            <div class="flex items-center flex-1 min-w-0" onclick="loadTextIntoEditor(${text.id})">
                <svg class="mr-3 w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
                <div class="flex-1 min-w-0">
                    <div class="text-sm font-medium text-white truncate">${text.title}</div>
                    <div class="text-xs text-gray-400">${currentDate}</div>
                </div>
            </div>
            <div class="flex items-center space-x-1">
                <button onclick="editText(${text.id})" class="text-gray-400 hover:text-blue-400 transition-colors">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                    </svg>
                </button>
                <button onclick="deleteText(${text.id})" class="text-gray-400 hover:text-red-400 transition-colors">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                    </svg>
                </button>
            </div>
        `;
        
        // Add to the top of the list (most recent first)
        textsList.insertBefore(textElement, textsList.firstChild);
    }

    // Debounced auto-save function
    function scheduleAutoSave() {
        // Don't schedule auto-save if we're loading a text
        if (isLoadingText) {
            return;
        }
        
        clearTimeout(autoSaveTimeout);
        autoSaveTimeout = setTimeout(() => {
            autoSaveCurrentText();
        }, 2000); // Save after 2 seconds of inactivity
    }

    // Get clean text content excluding AI suggestions
    function getCleanEditorContent() {
        const editorElement = document.getElementById('editor');
        const clonedEditor = editorElement.cloneNode(true);
        
        // Remove AI suggestion elements
        const suggestionElements = clonedEditor.querySelectorAll('.ai-suggestion');
        suggestionElements.forEach(el => el.remove());
        
        // Get clean text content
        return clonedEditor.textContent || clonedEditor.innerText || '';
    }

    // Auto-save current text
    async function autoSaveCurrentText() {
        // Skip if we're loading text
        if (isLoadingText) {
            return;
        }
        
        const title = document.getElementById('title-input').value.trim();
        const cleanContent = getCleanEditorContent().trim();
        
        // Don't save if no title, no content, or no changes
        if (!title || !cleanContent || (title === lastSavedTitle && cleanContent === lastSavedContent)) {
            return;
        }
        
        try {
            let response;
            if (currentActiveTextId) {
                // Update existing text
                response = await fetch(`/api/texts/${currentActiveTextId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        title: title,
                        content: cleanContent
                    })
                });
            } else {
                // Create new text
                response = await fetch('/api/texts', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        title: title,
                        content: cleanContent
                    })
                });
            }
            
            const result = await response.json();
            
            if (result.success) {
                currentActiveTextId = result.text.id;
                window.currentActiveTextId = result.text.id;
                lastSavedTitle = title;
                lastSavedContent = cleanContent;
                
                // Update the text list if this is a new text
                if (!document.querySelector(`[data-text-id="${currentActiveTextId}"]`)) {
                    addTextToSidebar(result.text);
                }
            }
        } catch (error) {
            console.error('Auto-save failed:', error);
        }
    }

    // Start new text (clear current active text)
    function startNewText() {
        // Set loading flag to prevent auto-save during clearing
        isLoadingText = true;
        
        currentActiveTextId = null;
        window.currentActiveTextId = null;
        document.getElementById('title-input').value = '';
        const editorElement = document.getElementById('editor');
        editorElement.innerHTML = ''; // Clear all HTML content
        editorElement.textContent = ''; // Set empty text
        
        // Reset editor height to minimum
        setTimeout(autoResizeEditor, 10);
        
        // Reset tracking variables AFTER clearing content
        lastSavedTitle = '';
        lastSavedContent = '';
        
        // Update writing statistics after clearing content
        if (window.editor) {
            setTimeout(() => window.editor.updateStats(), 50);
        }
        
        // Remove active styling from all texts
        document.querySelectorAll('[data-text-id]').forEach(el => {
            el.classList.remove('bg-gray-900');
        });
        
        // Re-enable auto-save quickly
        setTimeout(() => {
            isLoadingText = false;
        }, 50);
    }

    // Updated loadText function to set active text
    async function loadTextIntoEditor(textId) {
        // Prevent multiple simultaneous loads
        if (isLoadingText) {
            return;
        }
        
        try {
            // Set loading flag to prevent auto-save interference
            isLoadingText = true;
            
            const response = await fetch(`/api/texts/${textId}`);
            const result = await response.json();
            
            if (result.success) {
                currentActiveTextId = textId;
                window.currentActiveTextId = textId;
                
                document.getElementById('title-input').value = result.text.title;
                const editorElement = document.getElementById('editor');
                editorElement.innerHTML = ''; // Clear editor first
                editorElement.textContent = result.text.content || ''; // Set as plain text
                
                // Auto-resize editor after loading content
                setTimeout(autoResizeEditor, 10);
                
                // Update tracking variables with the actual content from database
                lastSavedTitle = result.text.title;
                lastSavedContent = result.text.content || '';
                
                // Update writing statistics after loading content
                if (window.editor) {
                    setTimeout(() => window.editor.updateStats(), 50);
                }
                
                // Update active text styling
                document.querySelectorAll('[data-text-id]').forEach(el => {
                    el.classList.remove('bg-gray-900');
                });
                document.querySelector(`[data-text-id="${textId}"]`).classList.add('bg-gray-900');
            }
        } catch (error) {
            console.error('Failed to load text:', error);
        } finally {
            // Always clear loading flag quickly
            setTimeout(() => {
                isLoadingText = false;
            }, 100); // Minimal delay to ensure DOM is updated
        }
    }

    // Expose functions globally for editor.js to call
    window.scheduleAutoSave = scheduleAutoSave;
    window.autoResizeEditor = autoResizeEditor;

    // Auto-resize editor function
    function autoResizeEditor() {
        const editor = document.getElementById('editor');
        const container = editor.parentElement.parentElement;
        
        // Reset height to auto to get the natural height
        editor.style.height = 'auto';
        container.style.height = 'auto';
        
        // Get the scroll height (natural content height)
        const scrollHeight = editor.scrollHeight;
        const minHeight = 384; // 24rem (h-96) = 384px
        
        // Set the height to either the content height or minimum height
        const newHeight = Math.max(scrollHeight + 48, minHeight); // +48 for padding
        
        editor.style.height = newHeight + 'px';
        container.style.height = (newHeight + 48) + 'px'; // +48 for container padding
    }

    // Add event listeners for auto-save and auto-resize
    document.getElementById('editor').addEventListener('input', function() {
        scheduleAutoSave();
        autoResizeEditor();
    });
    
    // Handle paste events
    document.getElementById('editor').addEventListener('paste', () => {
        setTimeout(() => {
            scheduleAutoSave();
            autoResizeEditor();
        }, 100); // Small delay to let paste complete
    });

    // Handle first click on editor - start new text if needed
    document.getElementById('editor').addEventListener('focus', function(e) {
        const title = document.getElementById('title-input').value.trim();
        const content = getCleanEditorContent().trim();
        
        // If there's a title but no active text and no content, prepare for new text
        if (title && !currentActiveTextId && !content) {
            // Clear any existing tracking to start fresh
            lastSavedTitle = '';
            lastSavedContent = '';
        }
    });

    // Text-Document Association Functions
    async function loadTextDocuments(textId) {
        if (!textId) {
            document.getElementById('text-documents-section').style.display = 'none';
            return;
        }

        try {
            const response = await fetch(`/api/texts/${textId}/documents`);
            const result = await response.json();
            
            if (result.success) {
                const documentsList = document.getElementById('text-documents-list');
                documentsList.innerHTML = '';
                
                // Always show the text documents section when a text is active
                document.getElementById('text-documents-section').style.display = 'block';
                
                if (result.documents.length > 0) {
                    result.documents.forEach(doc => {
                        const docElement = document.createElement('div');
                        docElement.className = 'flex items-center justify-between px-3 py-2 text-sm text-gray-300 bg-gray-900 rounded-lg';
                        docElement.innerHTML = `
                            <div class="flex items-center flex-1 min-w-0">
                                <svg class="mr-3 w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                                <div class="flex-1 min-w-0">
                                    <div class="text-sm font-medium text-white truncate">${doc.filename}</div>
                                    <div class="text-xs text-gray-400">${doc.file_type.toUpperCase()} â€¢ ${Math.round(doc.file_size / 1024)}KB</div>
                                </div>
                            </div>
                            <button onclick="removeDocumentFromText(${textId}, ${doc.id})" class="ml-2 text-gray-400 hover:text-red-400 transition-colors">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        `;
                        documentsList.appendChild(docElement);
                    });
                } else {
                    // Show a message when no documents are associated
                    const emptyMessage = document.createElement('div');
                    emptyMessage.className = 'text-xs text-gray-400 italic text-center py-2';
                    emptyMessage.textContent = 'No documents associated with this text';
                    documentsList.appendChild(emptyMessage);
                }
            }
        } catch (error) {
            console.error('Failed to load text documents:', error);
        }
    }

    async function showAddDocumentModal() {
        if (!currentActiveTextId) {
            alert('Please select a text first');
            return;
        }

        try {
            const response = await fetch(`/api/texts/${currentActiveTextId}/available-documents`);
            const result = await response.json();
            
            if (result.success) {
                const availableList = document.getElementById('available-documents-list');
                const noDocsMessage = document.getElementById('no-documents-message');
                
                availableList.innerHTML = '';
                
                if (result.documents.length > 0) {
                    noDocsMessage.classList.add('hidden');
                    
                    result.documents.forEach(doc => {
                        const docElement = document.createElement('div');
                        docElement.className = 'flex items-center justify-between px-3 py-2 text-sm text-gray-300 hover:bg-gray-900 rounded-lg cursor-pointer transition-colors';
                        docElement.innerHTML = `
                            <div class="flex items-center flex-1 min-w-0">
                                <svg class="mr-3 w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                                <div class="flex-1 min-w-0">
                                    <div class="text-sm font-medium text-white truncate">${doc.filename}</div>
                                    <div class="text-xs text-gray-400">${doc.file_type.toUpperCase()} â€¢ ${Math.round(doc.file_size / 1024)}KB</div>
                                </div>
                            </div>
                            <button onclick="addDocumentToText(${currentActiveTextId}, ${doc.id})" class="ml-2 px-3 py-1 text-xs bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors">
                                Add
                            </button>
                        `;
                        availableList.appendChild(docElement);
                    });
                } else {
                    noDocsMessage.classList.remove('hidden');
                }
                
                document.getElementById('add-document-modal').classList.remove('hidden');
            }
        } catch (error) {
            console.error('Failed to load available documents:', error);
            alert('Failed to load available documents');
        }
    }

    function closeAddDocumentModal() {
        document.getElementById('add-document-modal').classList.add('hidden');
    }

    async function addDocumentToText(textId, documentId) {
        try {
            const response = await fetch(`/api/texts/${textId}/documents/${documentId}`, {
                method: 'POST'
            });
            
            const result = await response.json();
            
            if (result.success) {
                closeAddDocumentModal();
                loadTextDocuments(textId);
            } else {
                alert(result.error || 'Failed to add document');
            }
        } catch (error) {
            console.error('Failed to add document to text:', error);
            alert('Failed to add document to text');
        }
    }

    async function removeDocumentFromText(textId, documentId) {
        if (!confirm('Remove this document from the current text?')) return;
        
        try {
            const response = await fetch(`/api/texts/${textId}/documents/${documentId}`, {
                method: 'DELETE'
            });
            
            const result = await response.json();
            
            if (result.success) {
                loadTextDocuments(textId);
            } else {
                alert(result.error || 'Failed to remove document');
            }
        } catch (error) {
            console.error('Failed to remove document from text:', error);
            alert('Failed to remove document from text');
        }
    }

    // Update loadTextIntoEditor to also load associated documents
    const originalLoadTextIntoEditor = loadTextIntoEditor;
    loadTextIntoEditor = async function(textId) {
        await originalLoadTextIntoEditor(textId);
        await loadTextDocuments(textId);
    };

    // Update startNewText to hide text documents section
    const originalStartNewText = startNewText;
    startNewText = function() {
        originalStartNewText();
        document.getElementById('text-documents-section').style.display = 'none';
    };

    // Close modal when clicking outside
    document.getElementById('add-document-modal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeAddDocumentModal();
        }
    });

    // Check subscription status and show notifications
    {% if not has_valid_access %}
        // Show subscription expired notification
        setTimeout(function() {
            if (!sessionStorage.getItem('subscription_notified')) {
                const notification = document.createElement('div');
                notification.className = 'fixed top-20 right-4 bg-red-950 border border-red-800 text-white p-4 rounded-lg shadow-lg z-50 max-w-sm';
                notification.innerHTML = `
                    <div class="flex items-start">
                        <svg class="w-5 h-5 text-red-400 mt-0.5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                        </svg>
                        <div class="flex-1">
                            <h4 class="font-medium mb-1">{% if subscription_status == 'trial' %}Trial Expired{% else %}Subscription Inactive{% endif %}</h4>
                            <p class="text-sm text-gray-300 mb-3">
                                {% if subscription_status == 'trial' %}
                                    Your free trial has ended. Choose a plan to continue using Writify.
                                {% elif subscription_status == 'past_due' %}
                                    Please update your payment method to reactivate your account.
                                {% else %}
                                    Your subscription is inactive. Choose a plan to continue.
                                {% endif %}
                            </p>
                            <div class="flex space-x-2">
                                <a href="{{ url_for('billing.pricing') }}" class="text-xs bg-red-700 hover:bg-red-800 text-white px-3 py-1 rounded transition-colors">
                                    {% if subscription_status == 'past_due' %}Update Payment{% else %}Choose Plan{% endif %}
                                </a>
                                <button onclick="this.closest('.fixed').remove(); sessionStorage.setItem('subscription_notified', 'true');" class="text-xs text-gray-400 hover:text-white">
                                    Dismiss
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(notification);
                
                // Auto dismiss after 10 seconds
                setTimeout(() => {
                    if (document.body.contains(notification)) {
                        notification.remove();
                        sessionStorage.setItem('subscription_notified', 'true');
                    }
                }, 10000);
            }
        }, 1000);
    {% elif is_trial_active and days_left_in_trial <= 3 %}
        // Show trial ending soon notification
        setTimeout(function() {
            if (!sessionStorage.getItem('trial_warning_shown')) {
                const notification = document.createElement('div');
                notification.className = 'fixed top-20 right-4 bg-orange-950 border border-orange-800 text-white p-4 rounded-lg shadow-lg z-50 max-w-sm';
                notification.innerHTML = `
                    <div class="flex items-start">
                        <svg class="w-5 h-5 text-orange-400 mt-0.5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <div class="flex-1">
                            <h4 class="font-medium mb-1">Trial Ending Soon</h4>
                            <p class="text-sm text-gray-300 mb-3">
                                Only {{ days_left_in_trial }} day{{ 's' if days_left_in_trial != 1 else '' }} left in your trial. Choose a plan to continue.
                            </p>
                            <div class="flex space-x-2">
                                <a href="{{ url_for('billing.pricing') }}" class="text-xs bg-orange-700 hover:bg-orange-800 text-white px-3 py-1 rounded transition-colors">
                                    Choose Plan
                                </a>
                                <button onclick="this.closest('.fixed').remove(); sessionStorage.setItem('trial_warning_shown', 'true');" class="text-xs text-gray-400 hover:text-white">
                                    Dismiss
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(notification);
                
                // Auto dismiss after 8 seconds
                setTimeout(() => {
                    if (document.body.contains(notification)) {
                        notification.remove();
                        sessionStorage.setItem('trial_warning_shown', 'true');
                    }
                }, 8000);
            }
        }, 2000);
    {% endif %}

</script>
{% endblock %}