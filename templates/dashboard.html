{% extends "base.html" %}

{% block title %}Dashboard - Writify{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-900 text-white">
    <!-- Navigation Bar -->
    <nav class="border-b border-gray-800 bg-gray-900/95 backdrop-blur-sm sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <!-- Logo -->
                <div class="flex items-center">
                    <span class="text-xl font-semibold">Writify.</span>
                </div>

                <!-- User Menu -->
                <div class="flex items-center space-x-4">
                    <div class="flex items-center space-x-3">
                        {% if user.avatar_url %}
                            <img src="{{ user.avatar_url }}" alt="{{ user.full_name }}" class="w-8 h-8 rounded-full">
                        {% else %}
                            <div class="w-8 h-8 bg-gray-700 rounded-full flex items-center justify-center">
                                <span class="text-sm font-medium">{{ user.first_name[0] }}{{ user.last_name[0] }}</span>
                            </div>
                        {% endif %}
                        <span class="text-sm font-medium">{{ user.first_name }}</span>
                    </div>
                    <button onclick="document.getElementById('create-dropdown').classList.toggle('hidden')" class="inline-flex items-center px-3 py-2 border border-gray-600 rounded-md text-sm font-medium text-white hover:bg-gray-800 transition-colors">
                        Create new
                        <svg class="ml-2 w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                        </svg>
                    </button>
                    <!-- Dropdown -->
                    <div id="create-dropdown" class="hidden absolute right-8 top-16 mt-2 w-48 bg-gray-800 border border-gray-700 rounded-md shadow-lg z-50">
                        <div class="py-1">
                            <a href="#" onclick="startNewText(); return false;" class="block px-4 py-2 text-sm text-gray-300 hover:bg-gray-700">New Text</a>
                            <div class="border-t border-gray-700 my-1"></div>
                            <a href="{{ url_for('auth.logout') }}" class="block px-4 py-2 text-sm text-gray-300 hover:bg-gray-700">Sign out</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="flex">
        <!-- Sidebar -->
        <aside class="w-64 bg-gray-800 border-r border-gray-700 min-h-screen">
            <div class="p-6">
                <!-- Search -->
                <div class="mb-6">
                    <div class="relative">
                        <input type="text" placeholder="Search..." class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md text-sm text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-white focus:border-transparent">
                        <svg class="absolute right-3 top-2.5 w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                    </div>
                </div>

                <!-- Navigation Menu -->
                <nav class="space-y-2">
                    <a href="#" class="flex items-center px-3 py-2 text-sm font-medium text-white bg-gray-700 rounded-md">
                        <svg class="mr-3 w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
                        </svg>
                        History
                    </a>
                    <a href="#" class="flex items-center px-3 py-2 text-sm font-medium text-gray-300 hover:text-white hover:bg-gray-700 rounded-md transition-colors">
                        <svg class="mr-3 w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
                        </svg>
                        Collections
                    </a>
                </nav>

                <!-- Uploaded Documents -->
                <div class="mt-8">
                    <h3 class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-3">Documents</h3>
                    <div id="documents-list" class="space-y-2">
                        {% for document in documents %}
                        <div class="flex items-center justify-between px-3 py-2 text-sm text-gray-300 hover:bg-gray-700 rounded-md cursor-pointer transition-colors" data-document-id="{{ document.id }}">
                            <div class="flex items-center flex-1 min-w-0">
                                <svg class="mr-3 w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                                <div class="flex-1 min-w-0">
                                    <div class="text-sm font-medium text-white truncate">{{ document.original_filename }}</div>
                                    <div class="text-xs text-gray-400">{{ document.file_type.upper() }} â€¢ {{ (document.file_size / 1024) | round(1) }}KB</div>
                                </div>
                            </div>
                            <button onclick="deleteDocument({{ document.id }})" class="ml-2 text-gray-400 hover:text-red-400 transition-colors">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                </svg>
                            </button>
                        </div>
                        {% endfor %}
                    </div>
                    
                    <!-- Upload Button -->
                    <div class="mt-3">
                        <input type="file" id="file-upload" accept=".pdf,.docx" class="hidden" onchange="uploadDocument()">
                        <button onclick="document.getElementById('file-upload').click()" class="w-full flex items-center justify-center px-3 py-2 border border-gray-600 text-gray-300 text-sm rounded-md hover:bg-gray-700 transition-colors">
                            <svg class="mr-2 w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                            </svg>
                            Upload PDF/DOCX
                        </button>
                    </div>
                </div>

                <!-- Saved Texts -->
                <div class="mt-8">
                    <h3 class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-3">My Texts</h3>
                    <div id="texts-list" class="space-y-2">
                        {% for text in texts %}
                        <div class="flex items-center justify-between px-3 py-2 text-sm text-gray-300 hover:bg-gray-700 rounded-md cursor-pointer transition-colors" data-text-id="{{ text.id }}">
                            <div class="flex items-center flex-1 min-w-0" onclick="loadTextIntoEditor({{ text.id }})">
                                <svg class="mr-3 w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                                <div class="flex-1 min-w-0">
                                    <div class="text-sm font-medium text-white truncate">{{ text.title }}</div>
                                    <div class="text-xs text-gray-400">{{ text.updated_at.strftime('%m/%d/%Y') }}</div>
                                </div>
                            </div>
                            <div class="flex items-center space-x-1">
                                <button onclick="editText({{ text.id }})" class="text-gray-400 hover:text-blue-400 transition-colors">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                    </svg>
                                </button>
                                <button onclick="deleteText({{ text.id }})" class="text-gray-400 hover:text-red-400 transition-colors">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    
                    <!-- New Text Button -->
                    <div class="mt-3">
                        <button onclick="createNewText()" class="w-full flex items-center justify-center px-3 py-2 border border-gray-600 text-gray-300 text-sm rounded-md hover:bg-gray-700 transition-colors">
                            <svg class="mr-2 w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                            </svg>
                            New Text
                        </button>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Content Area -->
        <main class="flex-1 flex flex-col">
            <!-- Title Input -->
            <div class="p-6 border-b border-gray-700">
                <input type="text" id="title-input" placeholder="Enter your writing title..." class="w-full text-2xl font-bold text-white bg-transparent border-none outline-none placeholder-gray-500" value="" />
            </div>

            <!-- Writing Area -->
            <div class="flex-1 p-6">
                <div class="max-w-4xl mx-auto">
                    <div class="bg-gray-800 rounded-lg border border-gray-700 min-h-96">
                        <div class="relative">
                            <!-- Modern AI Editor - Single Layer -->
                            <div id="editor-container" class="relative">
                                <div id="editor" 
                                     contenteditable="true" 
                                     class="w-full min-h-96 bg-transparent border-none outline-none text-gray-300 resize-none"
                                     style="font-family: ui-serif, Georgia, Cambria, serif; line-height: 1.7; padding: 24px; margin: 0; box-sizing: border-box; overflow: visible;"
                                     data-placeholder="Start writing... AI suggestions will appear inline as you type.">
                                </div>
                                
                                <!-- Floating Suggestion Controls -->
                                <div id="suggestion-controls" class="hidden fixed z-50 bg-gray-800 rounded-lg shadow-lg border border-gray-600">
                                    <div class="flex items-center space-x-3 px-4 py-2 text-sm">
                                        <button id="accept-btn" class="flex items-center space-x-1 px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors">
                                            <span>Accept</span>
                                            <kbd class="ml-1 px-1 py-0.5 bg-blue-700 text-xs rounded">Tab</kbd>
                                        </button>
                                        <button id="try-again-btn" class="flex items-center space-x-1 px-3 py-1 border border-gray-600 text-gray-300 rounded hover:bg-gray-700 transition-colors">
                                            <span>Try Again</span>
                                            <kbd class="ml-1 px-1 py-0.5 bg-gray-600 text-xs rounded">Shift+Tab</kbd>
                                        </button>
                                        <button id="dismiss-btn" class="flex items-center space-x-1 px-3 py-1 border border-gray-600 text-gray-300 rounded hover:bg-gray-700 transition-colors">
                                            <span>Dismiss</span>
                                            <kbd class="ml-1 px-1 py-0.5 bg-gray-600 text-xs rounded">Esc</kbd>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- CSS for placeholder and suggestions -->
                            <style>
                                #editor:empty:before {
                                    content: attr(data-placeholder);
                                    color: #6b7280;
                                    pointer-events: none;
                                }
                                #editor:focus {
                                    outline: none;
                                }
                                .ai-suggestion {
                                    color: #6b7280;
                                    background: rgba(59, 130, 246, 0.1);
                                    border-radius: 2px;
                                    padding: 0 2px;
                                }
                                /* Auto-expanding editor */
                                #editor {
                                    overflow-wrap: break-word;
                                    word-wrap: break-word;
                                    white-space: pre-wrap;
                                }
                                .bg-gray-800.rounded-lg.border.border-gray-700 {
                                    overflow: visible;
                                }
                            </style>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Right Panel -->
        <aside class="w-80 bg-gray-800 border-l border-gray-700 p-6">
            <div class="space-y-6">
                <!-- Writing Stats -->
                <div>
                    <h3 class="text-sm font-semibold text-white mb-3">Writing Stats</h3>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between text-gray-300">
                            <span>Words</span>
                            <span id="word-count">0</span>
                        </div>
                        <div class="flex justify-between text-gray-300">
                            <span>Characters</span>
                            <span id="char-count">0</span>
                        </div>
                        <div class="flex justify-between text-gray-300">
                            <span>Reading time</span>
                            <span id="reading-time">0 min</span>
                        </div>
                    </div>
                </div>

                <!-- AI Status -->
                <div>
                    <h3 class="text-sm font-semibold text-white mb-3">AI Assistant</h3>
                    <div id="ai-status" class="bg-gray-700 rounded-lg p-4">
                        <div class="flex items-center text-sm text-gray-400">
                            <div class="w-2 h-2 bg-green-400 rounded-full mr-2"></div>
                            Ready - Start writing with a title
                        </div>
                    </div>
                </div>

                <!-- Status Indicator -->
                <div id="status-indicator" class="hidden">
                    <div class="flex items-center text-sm text-gray-400">
                        <svg class="animate-spin mr-2 w-4 h-4" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        Getting AI suggestions...
                    </div>
                </div>
                
                <!-- Help Text -->
                <div class="text-xs text-gray-500 bg-gray-700 rounded-lg p-3">
                    <div class="space-y-1">
                        <div><kbd class="bg-gray-600 px-1 rounded">Tab</kbd> Accept suggestion</div>
                        <div><kbd class="bg-gray-600 px-1 rounded">Shift+Tab</kbd> Try again</div>
                        <div><kbd class="bg-gray-600 px-1 rounded">Esc</kbd> Dismiss</div>
                    </div>
                </div>
            </div>
        </aside>
    </div>

    <!-- Modal for Create/Edit Text -->
    <div id="text-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-gray-800 rounded-lg max-w-2xl w-full max-h-[90vh] overflow-hidden">
            <div class="flex justify-between items-center p-6 border-b border-gray-700">
                <h3 id="modal-title" class="text-lg font-semibold text-white">New Text</h3>
                <button onclick="closeTextModal()" class="text-gray-400 hover:text-white">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <form id="text-form" class="flex flex-col h-full">
                <div class="p-6 flex-1 overflow-y-auto">
                    <div class="mb-4">
                        <label for="text-title" class="block text-sm font-medium text-gray-300 mb-2">Title</label>
                        <input type="text" id="text-title" name="title" required
                               class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                               placeholder="Enter text title...">
                    </div>
                    <div class="mb-4">
                        <label for="text-content" class="block text-sm font-medium text-gray-300 mb-2">Content</label>
                        <textarea id="text-content" name="content" rows="15"
                                  class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none"
                                  placeholder="Write your text here..."></textarea>
                    </div>
                </div>
                <div class="flex justify-end space-x-3 p-6 border-t border-gray-700">
                    <button type="button" onclick="closeTextModal()" 
                            class="px-4 py-2 text-gray-300 hover:text-white transition-colors">
                        Cancel
                    </button>
                    <button type="submit" 
                            class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors">
                        Save Text
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script src="{{ url_for('static', filename='js/editor.js') }}"></script>
<script>
    // Close dropdown when clicking outside
    document.addEventListener('click', function(event) {
        const dropdown = document.getElementById('create-dropdown');
        const button = event.target.closest('button[onclick*="create-dropdown"]');
        
        if (!button && !dropdown.contains(event.target)) {
            dropdown.classList.add('hidden');
        }
    });

    // Document upload function
    async function uploadDocument() {
        const fileInput = document.getElementById('file-upload');
        const file = fileInput.files[0];
        
        if (!file) return;
        
        const formData = new FormData();
        formData.append('file', file);
        
        try {
            const response = await fetch('/api/upload', {
                method: 'POST',
                body: formData
            });
            
            const result = await response.json();
            
            if (result.success) {
                // Document uploaded successfully - could add to sidebar dynamically here if needed
                console.log('Document uploaded successfully');
            } else {
                alert(result.error || 'Upload failed');
            }
        } catch (error) {
            alert('Upload failed. Please try again.');
        }
        
        fileInput.value = ''; // Reset input
    }

    // Document delete function
    async function deleteDocument(documentId) {
        if (!confirm('Are you sure you want to delete this document?')) return;
        
        try {
            const response = await fetch(`/api/documents/${documentId}`, {
                method: 'DELETE'
            });
            
            const result = await response.json();
            
            if (result.success) {
                // Remove document from sidebar dynamically
                const documentElement = document.querySelector(`[data-document-id="${documentId}"]`);
                if (documentElement) {
                    documentElement.remove();
                }
            } else {
                alert('Failed to delete document');
            }
        } catch (error) {
            alert('Failed to delete document. Please try again.');
        }
    }

    // Text management variables
    let currentTextId = null;
    let isEditMode = false;

    // Create new text
    function createNewText() {
        currentTextId = null;
        isEditMode = false;
        document.getElementById('modal-title').textContent = 'New Text';
        document.getElementById('text-title').value = '';
        document.getElementById('text-content').value = '';
        document.getElementById('text-modal').classList.remove('hidden');
    }

    // Edit existing text
    async function editText(textId) {
        try {
            const response = await fetch(`/api/texts/${textId}`);
            const result = await response.json();
            
            if (result.success) {
                currentTextId = textId;
                isEditMode = true;
                document.getElementById('modal-title').textContent = 'Edit Text';
                document.getElementById('text-title').value = result.text.title;
                document.getElementById('text-content').value = result.text.content || '';
                document.getElementById('text-modal').classList.remove('hidden');
            } else {
                alert('Failed to load text');
            }
        } catch (error) {
            alert('Failed to load text. Please try again.');
        }
    }


    // Delete text
    async function deleteText(textId) {
        if (!confirm('Are you sure you want to delete this text?')) return;
        
        try {
            const response = await fetch(`/api/texts/${textId}`, {
                method: 'DELETE'
            });
            
            const result = await response.json();
            
            if (result.success) {
                // Remove text from sidebar
                const textElement = document.querySelector(`[data-text-id="${textId}"]`);
                if (textElement) {
                    textElement.remove();
                }
                
                // If this was the active text, clear the editor
                if (currentActiveTextId === textId) {
                    startNewText();
                }
            } else {
                alert('Failed to delete text');
            }
        } catch (error) {
            alert('Failed to delete text. Please try again.');
        }
    }

    // Close modal
    function closeTextModal() {
        document.getElementById('text-modal').classList.add('hidden');
        currentTextId = null;
        isEditMode = false;
    }

    // Handle form submission
    document.getElementById('text-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const title = document.getElementById('text-title').value.trim();
        const content = document.getElementById('text-content').value.trim();
        
        if (!title) {
            alert('Title is required');
            return;
        }
        
        try {
            const url = isEditMode ? `/api/texts/${currentTextId}` : '/api/texts';
            const method = isEditMode ? 'PUT' : 'POST';
            
            const response = await fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    title: title,
                    content: content
                })
            });
            
            const result = await response.json();
            
            if (result.success) {
                closeTextModal();
                // Update text in sidebar if it exists, otherwise add it
                const existingTextElement = document.querySelector(`[data-text-id="${result.text.id}"]`);
                if (existingTextElement) {
                    // Update existing text title in sidebar
                    const titleElement = existingTextElement.querySelector('.text-sm.font-medium.text-white.truncate');
                    if (titleElement) {
                        titleElement.textContent = result.text.title;
                    }
                } else {
                    addTextToSidebar(result.text);
                }
            } else {
                alert(result.error || 'Failed to save text');
            }
        } catch (error) {
            alert('Failed to save text. Please try again.');
        }
    });

    // Close modal when clicking outside
    document.getElementById('text-modal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeTextModal();
        }
    });

    // Close modal with Escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && !document.getElementById('text-modal').classList.contains('hidden')) {
            closeTextModal();
        }
    });

    // Auto-save functionality
    let currentActiveTextId = null;
    let autoSaveTimeout = null;
    let lastSavedTitle = '';
    let lastSavedContent = '';
    let isLoadingText = false; // Flag to prevent auto-save during text loading

    // Add text to sidebar dynamically
    function addTextToSidebar(text) {
        const textsList = document.getElementById('texts-list');
        const currentDate = new Date(text.updated_at).toLocaleDateString();
        
        const textElement = document.createElement('div');
        textElement.className = 'flex items-center justify-between px-3 py-2 text-sm text-gray-300 hover:bg-gray-700 rounded-md cursor-pointer transition-colors bg-gray-700';
        textElement.setAttribute('data-text-id', text.id);
        
        textElement.innerHTML = `
            <div class="flex items-center flex-1 min-w-0" onclick="loadTextIntoEditor(${text.id})">
                <svg class="mr-3 w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
                <div class="flex-1 min-w-0">
                    <div class="text-sm font-medium text-white truncate">${text.title}</div>
                    <div class="text-xs text-gray-400">${currentDate}</div>
                </div>
            </div>
            <div class="flex items-center space-x-1">
                <button onclick="editText(${text.id})" class="text-gray-400 hover:text-blue-400 transition-colors">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                    </svg>
                </button>
                <button onclick="deleteText(${text.id})" class="text-gray-400 hover:text-red-400 transition-colors">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                    </svg>
                </button>
            </div>
        `;
        
        // Add to the top of the list (most recent first)
        textsList.insertBefore(textElement, textsList.firstChild);
    }

    // Debounced auto-save function
    function scheduleAutoSave() {
        // Don't schedule auto-save if we're loading a text
        if (isLoadingText) {
            return;
        }
        
        clearTimeout(autoSaveTimeout);
        autoSaveTimeout = setTimeout(() => {
            autoSaveCurrentText();
        }, 2000); // Save after 2 seconds of inactivity
    }

    // Get clean text content excluding AI suggestions
    function getCleanEditorContent() {
        const editorElement = document.getElementById('editor');
        const clonedEditor = editorElement.cloneNode(true);
        
        // Remove AI suggestion elements
        const suggestionElements = clonedEditor.querySelectorAll('.ai-suggestion');
        suggestionElements.forEach(el => el.remove());
        
        // Get clean text content
        return clonedEditor.textContent || clonedEditor.innerText || '';
    }

    // Auto-save current text
    async function autoSaveCurrentText() {
        // Skip if we're loading text
        if (isLoadingText) {
            return;
        }
        
        const title = document.getElementById('title-input').value.trim();
        const cleanContent = getCleanEditorContent().trim();
        
        // Don't save if no title, no content, or no changes
        if (!title || !cleanContent || (title === lastSavedTitle && cleanContent === lastSavedContent)) {
            return;
        }
        
        try {
            let response;
            if (currentActiveTextId) {
                // Update existing text
                response = await fetch(`/api/texts/${currentActiveTextId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        title: title,
                        content: cleanContent
                    })
                });
            } else {
                // Create new text
                response = await fetch('/api/texts', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        title: title,
                        content: cleanContent
                    })
                });
            }
            
            const result = await response.json();
            
            if (result.success) {
                currentActiveTextId = result.text.id;
                lastSavedTitle = title;
                lastSavedContent = cleanContent;
                
                // Update the text list if this is a new text
                if (!document.querySelector(`[data-text-id="${currentActiveTextId}"]`)) {
                    addTextToSidebar(result.text);
                }
            }
        } catch (error) {
            console.error('Auto-save failed:', error);
        }
    }

    // Start new text (clear current active text)
    function startNewText() {
        // Set loading flag to prevent auto-save during clearing
        isLoadingText = true;
        
        currentActiveTextId = null;
        document.getElementById('title-input').value = '';
        const editorElement = document.getElementById('editor');
        editorElement.innerHTML = ''; // Clear all HTML content
        editorElement.textContent = ''; // Set empty text
        
        // Reset editor height to minimum
        setTimeout(autoResizeEditor, 10);
        
        // Reset tracking variables AFTER clearing content
        lastSavedTitle = '';
        lastSavedContent = '';
        
        // Remove active styling from all texts
        document.querySelectorAll('[data-text-id]').forEach(el => {
            el.classList.remove('bg-gray-700');
        });
        
        // Re-enable auto-save quickly
        setTimeout(() => {
            isLoadingText = false;
        }, 50);
    }

    // Updated loadText function to set active text
    async function loadTextIntoEditor(textId) {
        // Prevent multiple simultaneous loads
        if (isLoadingText) {
            return;
        }
        
        try {
            // Set loading flag to prevent auto-save interference
            isLoadingText = true;
            
            const response = await fetch(`/api/texts/${textId}`);
            const result = await response.json();
            
            if (result.success) {
                currentActiveTextId = textId;
                
                document.getElementById('title-input').value = result.text.title;
                const editorElement = document.getElementById('editor');
                editorElement.innerHTML = ''; // Clear editor first
                editorElement.textContent = result.text.content || ''; // Set as plain text
                
                // Auto-resize editor after loading content
                setTimeout(autoResizeEditor, 10);
                
                // Update tracking variables with the actual content from database
                lastSavedTitle = result.text.title;
                lastSavedContent = result.text.content || '';
                
                // Update active text styling
                document.querySelectorAll('[data-text-id]').forEach(el => {
                    el.classList.remove('bg-gray-700');
                });
                document.querySelector(`[data-text-id="${textId}"]`).classList.add('bg-gray-700');
            }
        } catch (error) {
            console.error('Failed to load text:', error);
        } finally {
            // Always clear loading flag quickly
            setTimeout(() => {
                isLoadingText = false;
            }, 100); // Minimal delay to ensure DOM is updated
        }
    }

    // Expose functions globally for editor.js to call
    window.scheduleAutoSave = scheduleAutoSave;
    window.autoResizeEditor = autoResizeEditor;

    // Auto-resize editor function
    function autoResizeEditor() {
        const editor = document.getElementById('editor');
        const container = editor.closest('.bg-gray-800.rounded-lg.border.border-gray-700');
        
        // Reset height to auto to get the natural height
        editor.style.height = 'auto';
        container.style.height = 'auto';
        
        // Get the scroll height (natural content height)
        const scrollHeight = editor.scrollHeight;
        const minHeight = 384; // 24rem (h-96) = 384px
        
        // Set the height to either the content height or minimum height
        const newHeight = Math.max(scrollHeight + 48, minHeight); // +48 for padding
        
        editor.style.height = newHeight + 'px';
        container.style.height = (newHeight + 48) + 'px'; // +48 for container padding
    }

    // Add event listeners for auto-save and auto-resize
    document.getElementById('editor').addEventListener('input', function() {
        scheduleAutoSave();
        autoResizeEditor();
    });
    
    // Handle paste events
    document.getElementById('editor').addEventListener('paste', () => {
        setTimeout(() => {
            scheduleAutoSave();
            autoResizeEditor();
        }, 100); // Small delay to let paste complete
    });

    // Handle first click on editor - start new text if needed
    document.getElementById('editor').addEventListener('focus', function(e) {
        const title = document.getElementById('title-input').value.trim();
        const content = getCleanEditorContent().trim();
        
        // If there's a title but no active text and no content, prepare for new text
        if (title && !currentActiveTextId && !content) {
            // Clear any existing tracking to start fresh
            lastSavedTitle = '';
            lastSavedContent = '';
        }
    });

</script>
{% endblock %}